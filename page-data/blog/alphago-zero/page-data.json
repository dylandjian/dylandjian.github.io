{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/blog/alphago-zero/","result":{"data":{"site":{"siteMetadata":{"title":"Dylan's Blog"}},"markdownRemark":{"id":"d9cbcd1d-8083-57cc-889e-66e7290ed373","excerpt":"DeepMind has shaken the world of Reinforcement Learning and Go with its creation AlphaGo, and later AlphaGo Zero. It is the first computer program to beat\na…","html":"<br/>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/38e4014a67ebd4fca90235f1ed06c898/1cfc2/alphago.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.32911392405063%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAACIElEQVQozx1SW28SQRj9zrQP2mhq1LaiUlaglNYue5mFAoVKL/QCLOxldnsNlQrEexNfGuNL33wxJr75oH9A/6R+JF8mM9/MmZPvnEN4vodMBUkThTacGJtjlI6hFbGQQ0pCc6C3YHqwPFg+l9nj20ULuU3ic34HSUs8yotEfuqpjuwGA/JbSK8zuODCDmEHkCGkguHiWQkrDCFuFWMUYyp0aWWPUutYOxBSCScSTjypUDiKOzKY8Hu82ehDKoITkgynZagdjhK7g8T+iAxfmD6sgIweWQFZiuyASidUPue5bEVGjynLZySWt0hGs/Wzg0/fB9/+NsY3pHcXmpepw+Gce3W3Mci0RzNbw5md8ZPts+T+5Z2d8UztnKSCDEmsNilVag6v0x9+65//RDe/tNawEo6a6qIajfP1znb3WPdfb7//WvFeanWv6p4uvfBJhnDUhHl++b69X/74I/vuZ3nw5Xb5aLaiko244l9q1c49p51pj9aiq5T7Nn9ynWsNEnVFhbYoRsQfOGq6dJTtvkm3ho+bA9JdHlhGt2r9CUOM0gnJkCyfCh0quMSGeTA9YqmdCLZPax3Su9Bd2IGwQ2H2kK1hLoNFS+RqwmgLFulUVPuwfZbd9olNtzxINeUowTDWmc3XHDzQoB/C6CBpYLkBs8svDZfL7E3A81mO11Kdo1aMUe3zavlY3cXDNJNXL1B7BWcSD3titR3AVv89+wfwVX2E74J7PwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"alphago\"\n        title=\"alphago\"\n        src=\"/static/38e4014a67ebd4fca90235f1ed06c898/f058b/alphago.png\"\n        srcset=\"/static/38e4014a67ebd4fca90235f1ed06c898/c26ae/alphago.png 158w,\n/static/38e4014a67ebd4fca90235f1ed06c898/6bdcf/alphago.png 315w,\n/static/38e4014a67ebd4fca90235f1ed06c898/f058b/alphago.png 630w,\n/static/38e4014a67ebd4fca90235f1ed06c898/1cfc2/alphago.png 900w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<br/>\n<p>DeepMind has shaken the world of Reinforcement Learning and Go with its creation <em>AlphaGo</em>, and later <em>AlphaGo Zero</em>. It is the first computer program to beat\na human professional Go player without handicap on a 19 x 19 board. It has also beaten the world champion <strong>Lee Sedol</strong> 4 games to 1, <strong>Ke Jie</strong> (number one world ranked player at the time) and many other top ranked players with the <em>Zero</em> version. The game of Go is a difficult environment because of its\nvery large branching factor at every move which makes classical techniques such as alpha-beta pruning and heuristic search unrealistic. I will present my work\non reproducing the paper as closely as I could. This article will again require background knowledge in Machine Learning and Python, as I will make references to <a href=\"https://github.com/dylandjian/SuperGo\">my own implementation</a>. It will also require a little bit of knowledge about the game of Go.</p>\n<h2>Introduction</h2>\n<p>After watching and reading a lot of theory about Reinforcement Learning and Machine learning in general, I decided that I wanted to start implementing my first project. As a <em>(bad)</em> Go player and self-taught student in the field, I felt like the promise of learning how to play such a complex game <em>tabula rasa</em> was super interesting. I was using Keras at the time and really wanted to transition into PyTorch, so this was the perfect opportunity for it. It was a bit hard to get started on such a big project. The first resource that I found was <a href=\"https://applied-data.science/static/main/res/alpha_go_zero_cheat_sheet.png\">this amazing info graphic by David Foster</a> that I will be referencing throughout the article. After a few days of thinking and searching, I was ready to start building the entire pipeline, following the <a href=\"https://www.nature.com/articles/nature24270.epdf?author_access_token=VJXbVjaSHxFoctQQ4p2k4tRgN0jAjWel9jnR3ZoTv0PVW4gB86EEpGqTRDtpIz-2rmo8-KG06gqVobU5NSCFeHILHcVFUeMsbvwS-lxjqQGg98faovwjxeTUgZAUMnRQ\">Nature paper published by DeepMind</a>.</p>\n<h2>AlphaGo Zero</h2>\n<p>AlphaGo Zero pipeline is divided into three main components (just like the previous article on <a href=\"https://dylandjian.github.io/world-models/\">World Models</a>), each in a different process that runs the code asynchronously. The first component is the <strong>self-play</strong>. It is responsible for the data generation.\nThe second component is the <strong>training</strong>, where freshly generated data by the self-play component is used to improve the current best networks. The final part is the <strong>evaluation</strong>, which decides whether the trained agent is better than the agent that is currently used to generate data. This last part is crucial since generated data should always come from the best available networks in order to generate quality moves much quicker in the self-play process.\nTo better understand how these components interact with each other, I will describe the building blocks of the project independently and then later assemble them to form the global pipeline.</p>\n<center>. . .</center>\n<h2>The environment</h2>\n<p>Ideally, a good environment would be one where it is possible to play really fast and that has implemented the Go rules (atari, ko, komi and others). After some research, I stumbled upon an implementation in OpenAI Gym (<a href=\"https://github.com/openai/gym/blob/6af4a5b9b2755606c4e0becfe1fc876d33130526/gym/envs/board_game/go.py\">old version</a> that had the board environments) that was using <a href=\"https://github.com/openai/pachi-py\">pachi_py</a> which is a Python binding to the C++ <a href=\"https://github.com/pasky/pachi\">Pachi Go Engine</a>. After a few tweaks the engine was ready to be used.\nThe first tweak is the fact that the input of the agent is a special representation of the board, as shown in the figure below. The state is composed of the current position of the black stones as a binary map (1 where there is a black stone, 0 otherwise) as well as the past 7 board states. It is concatenated with the same input for the white stones. This is mainly done in case of a <em>ko</em>.\nFinally, a map full of 0 or 1 is added to represent which player is about to play. It is represented this way for the ease of implementation, however it can be encoded in a single bit otherwise.\n<br /></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 611px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3db437a6753c6220f43676a122382304/36bb5/input.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 74.0506329113924%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA4mAAAN/wHwU+XzAAACd0lEQVQoz3WTTUvjQBjHp0X0Uims4MG7X8Oe9STIgjfPHj36CQS/QdcP0F2EFZTUgyLoQQSxhwa2tpjaJE0madKmU/Ji5u1ZknTVZdnfaXhmfvPy/Bk0Ho8ty3IcZzAYYMcZj8dBENgY+75vGIbruq85mqZFUZT8DVLb7ZOTk8b3Hw8PDzc3N9fX16qqnp39rNfr9W/fHh8fLy4ums2moihCSPgEpRSlacoYo5RKKSlN397ehJBpmg0opYxSlsM5F0KMRt5o5AVB8CEDgMx53zKK4jhJUkqLCuccAFqt1tbW1tcc0xwCAJoEQbeXMSUE/mwDUjLGSFEBYIwBwOXlJUJoaWkJIdRutzOZUiqEYIwJMT/89vb2+Pj44OBgb2+vVqvt7Ox0u10AaDabCKHl5eWFhQVVVecyAGQdtvHr60AIsbu7ixAql8sIoVKphBBaXV1VFKXVatVqte3t7c3NTV3XP2QpZRRFGGMp5f7+frlcXltbq1arlUplZWWlVCqtr68TQjjnUdaPmHPOGJvL73DOLcs6PDysVquLi4uVSuVLzsbGRhRF0+l0oOsYO3k0dC4XaQFAkiSapkkpz8/Pj46OGo3G1dXV09OTruuz2czJ8X1/HpUQIgiCTqfzq9OxbRsA7u7uFEUJw7BYEYYhIcTzPEKIjW3XcYp059eWeTAFRcN7vd7p6amiKPf396qqmqZJCBFCfH5gJhcZ/kuSJLPZ7H+zc7m4g+97/X7fME09R9O0oWXZtm0YxsvLiz7Iiv1+X9f15+duGEYAkKYpiuMYAOI4xhi7rovz/2TlTCYTbzQyDGM4HGKMbdvGGJummaaplDKO499cU+Y8ExWB+QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"input\"\n        title=\"input\"\n        src=\"/static/3db437a6753c6220f43676a122382304/36bb5/input.png\"\n        srcset=\"/static/3db437a6753c6220f43676a122382304/c26ae/input.png 158w,\n/static/3db437a6753c6220f43676a122382304/6bdcf/input.png 315w,\n/static/3db437a6753c6220f43676a122382304/36bb5/input.png 611w\"\n        sizes=\"(max-width: 611px) 100vw, 611px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>The second tweak is to make sure that it is possible to play with the engine whether there is only one agent playing <em>(self-play, online)</em> or two <em>(evaluation or with another agent)</em>. Also, in order to make the most out of modern CPUs, the code had to be modified in order to run multiple instances of the engine in parallel.</p>\n<p>In addition to these tweaks, the code had to be adjusted to be able to use the Tromp-Taylor scoring to have a good estimate of the winner during the game in case it stops early (which will be explained in more details in the <em>training</em> section below).</p>\n<center>. . .</center>\n<h2>The agent</h2>\n<p>The agent is composed of <strong>three</strong> neural networks that work together : a <strong>feature extractor</strong>, a <strong>policy</strong> network and a <strong>value</strong> network. This is also why AlphaGo Zero is sometimes called the <em>two headed beast</em> : a body, which is the feature extractor, and two heads : policy and value. The feature extractor model creates its own representation of the board state. The policy model outputs a probability distribution over all the possible moves and the value model predicts a scalar value in the range <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">[</mo><mo>−</mo><mn>1</mn><mo separator=\"true\">;</mo><mn>1</mn><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">[-1;1]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord\">−</span><span class=\"mord\">1</span><span class=\"mpunct\">;</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">]</span></span></span></span></span> to represent which player is more likely to win given the current state of the board. Both the policy and value model use the output of the feature extractor as input. Let’s see how they actually work.</p>\n<h3>Feature extractor</h3>\n<p>The feature extractor model is a Residual Neural Network, which is a special Convolutional Neural Network <em>(CNN)</em>. Its particularity is that it has a skip connection before the output of a block. This type of connection is just adding the output of the last connection of the block with the input before applying a Rectified Linear Unit activation function <em>(ReLU)</em> to the result, as described in the figure below.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 335px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/75bfeab4bf3136cb81e944d14ef73052/c0051/residual.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 200%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAoCAIAAABxU02MAAAACXBIWXMAAA4mAAAN/wHwU+XzAAAEsUlEQVRIx4VWy0sjSRz2D5vTCIIIyqw46pCVUZhdvTiiBw/iRRF8zPQoCKOSwYsXT4JgUCQqPlZJDL4wWTMxnU7sd1W/k076uWtq6HTauPs7NN1V9dXvq6+++lU3OY3CfREvx9i23eQfit4BABRNMwyTyxHZbPbp6YmkyFKp5Lqubdv+wQ3AoiAQBHF7c3N9fX2fTKZSqXg8rqqqNyAIfknbsiwIIc9zpmEahlEul5+ennie95IHM3thGMbt7e34+PinT58uLy+Pj49vbm76+vpmZ2d1Xa+BXddVZDmbzZIkCQBfKBRomvHPaFmWaZoewWBm0zAURVFUleM4WZY1TbMsm2XZ/f39SCQiyzKO4xzHbW1txeNxb+VB2hBCL1s6nV5YWJiamqJpOh6PPzw8jI2NbWxseJoHBRNF8bV9Dmx4EGzbtiAIHhK12LbtiY/juCRJr9JGfX6pPHlM01RVVZZlCKEoipqmua7bhLplWRagIIgiFAQPAABgGMYDS5Kk67plWYZhCIJQA0uSRJJUdcMo0zQRQKuGR1tRFLTJtm0jjnW0AQABbRp+BsFIG0EQLMtCLeVymWGYbDZbLpcVRTEMo1ANxKJBZr9gBEF8/fq1u7s7k8kcHx/ncrnh4eGRkRFk3l9g9JHLERzHEUQex3MQCi85+6OONiKsKIoAIQBA04qu60aj0fn5+S9fvhwcHBwdHeUIYmpqan19XVXVxrR5nvfe9/b2JicnJyYmIpHI7u5uJpP5/Pnz4uKiLMtBMMoPAETKuf8ZQbXRE20jeqco6urq6vz8PBaLxePxRCLx19nZ6elpPp9/rjaiWDNJrhqP2cdkMsnzz7u9vr7e2dnZ29vz5x/P0dXVFQqF+vv711ZXXdetc5iqqvf3yRxBPGazlUrFdd2lpaW2trbBoaHu9+/fvn3727t3IyMjHR0dc3Nz3uFt8h8jRAa1PD4+RqPRg4ODnZ2dSCRydnZ2cnKyvb19fX1do+1fM4Twf8/zq96WZdkvWDgcbm9v39raikajqb9TMzMzXV1dqVSqBn5esKIQRJ6mGY7jKIpiWe65sJmmKIr5fF6SJFEUdV2vWpDQdb0OXKlUIISCKBYKBQCAWO2QJOno6AjDsEwmk06nSZLc3t5eWVmpA/tpIxm8w3xxcbG8vIzjOEE8Oz8SiYTDYV3XPWl/ZU7/TFMUheN4Ov2T4ziUmSAIkiQ5jgMA6LrOsizDMKVSqc6ejuMUi8VSqUQzjKqq6E7b39/v6el58+YNhmGrq6uJROLjx4+tra13d3eNaSPfBKqsbduGYSDPowoVBFeqoamqXg3XdWOx2NraGoZhy8vLP378+P79O4Zhi4vfDg8Pg94GANze3N7fJy8vE/lqrcEwrLm5ORQKDQwMdLS3t7S09Pf3f/jQ+w3DgvZ0HIflWJ7nIYTI25ubm4ODgxMTE0ODg7+HQqOjo9PT0wMDA+FwuIG3verpFUBRFHmep2lakiRN0yCEFEUpiuI4TlAwx3FQB2rwT8qyrN8ClmXVHQx0JxBEHnH2q21ZFgBAlmXDMCCEkiQJgtAgc7FYfFmDHMcplUr+SWuXO7oH/Rfny/B+Dvz/Uf+C/wGGbYHO2634bQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"test\"\n        title=\"test\"\n        src=\"/static/75bfeab4bf3136cb81e944d14ef73052/c0051/residual.png\"\n        srcset=\"/static/75bfeab4bf3136cb81e944d14ef73052/c26ae/residual.png 158w,\n/static/75bfeab4bf3136cb81e944d14ef73052/6bdcf/residual.png 315w,\n/static/75bfeab4bf3136cb81e944d14ef73052/c0051/residual.png 335w\"\n        sizes=\"(max-width: 335px) 100vw, 335px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Here is how it is defined in code.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">BasicBlock</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    Basic residual block with 2 convolutions and a skip connection\n    before the last ReLU activation.\n    \"\"\"</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> inplanes<span class=\"token punctuation\">,</span> planes<span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> downsample<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>BasicBlock<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n        self<span class=\"token punctuation\">.</span>conv1 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>inplanes<span class=\"token punctuation\">,</span> planes<span class=\"token punctuation\">,</span> kernel_size<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n                        stride<span class=\"token operator\">=</span>stride<span class=\"token punctuation\">,</span> padding<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> bias<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>bn1 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>BatchNorm2d<span class=\"token punctuation\">(</span>planes<span class=\"token punctuation\">)</span>\n\n        self<span class=\"token punctuation\">.</span>conv2 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>planes<span class=\"token punctuation\">,</span> planes<span class=\"token punctuation\">,</span> kernel_size<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n                        stride<span class=\"token operator\">=</span>stride<span class=\"token punctuation\">,</span> padding<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> bias<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>bn2 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>BatchNorm2d<span class=\"token punctuation\">(</span>planes<span class=\"token punctuation\">)</span>\n\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        residual <span class=\"token operator\">=</span> x\n\n        out <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>conv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n        out <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>relu<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>bn1<span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        out <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>conv2<span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">)</span>\n        out <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>bn2<span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">)</span>\n\n        out <span class=\"token operator\">+=</span> residual\n        out <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>relu<span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> out</code></pre></div>\n<br/>\n<p>Now that the Residual Block is defined, let’s add it into the final feature extractor model as defined in the paper.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Extractor</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> inplanes<span class=\"token punctuation\">,</span> outplanes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>Extractor<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>conv1 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>inplanes<span class=\"token punctuation\">,</span> outplanes<span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n                        kernel_size<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> padding<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> bias<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>bn1 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>BatchNorm2d<span class=\"token punctuation\">(</span>outplanes<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">for</span> block <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>BLOCKS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token builtin\">setattr</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> <span class=\"token string\">\"res{}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \\\n                BasicBlock<span class=\"token punctuation\">(</span>outplanes<span class=\"token punctuation\">,</span> outplanes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        x <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>relu<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>bn1<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>conv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">for</span> block <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>BLOCKS <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            x <span class=\"token operator\">=</span> <span class=\"token builtin\">getattr</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> <span class=\"token string\">\"res{}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n\n        feature_maps <span class=\"token operator\">=</span> <span class=\"token builtin\">getattr</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> <span class=\"token string\">\"res{}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>BLOCKS <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> feature_maps</code></pre></div>\n<br />\n<p>The final network is simply the result of a convolutional layer that is given as input to the residual layers.</p>\n<h3>Policy head</h3>\n<p>The policy network model is a simple convolutional layer (1 x 1 convolution to encode over the channels of the feature extractor output) with a batch normalization layer and a fully connected layer that outputs the probability distribution over the entire board, plus one extra move for the pass move.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 285px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/52744e3d74287d9dc7db4b7d55e6ab75/0e2fe/policy.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 117.08860759493672%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAIAAACEf/j0AAAACXBIWXMAAA4mAAAN/wHwU+XzAAACb0lEQVQ4y41UTU+zQBD213n1R3jUmzeP/gEPXoxejIknbby+Jz2Y18TWaIvaltKSBVrko0DZlV2WZVnzskop9k18DoSBfWbmmZ2ZDc65+EZRFEKIfr//9vbmuq6i9AAwAADj8VgdjTDG1Rn5slEZ1Y8oil5eXnqK0um0e4pimOZz97mnKBljooYmeS0IIbREHMcQwpznS7JMu6iBlyhKrxmlqqq+vr6ORlrn8fHv/T1C6LeROecIoVBiEQVhyL6TX0b2PM8wTdu2DdPUdR1CVK9NQ2qdXEhhEKIwDBYlKKUyLGOMUpplGaWUlU9KaaV0qVkIASGUtLXRGok0NSOEsiyr+3p6erq4uHAcBwCwiOOHh4fLy0tZM875RlnWIikRRRFCCGMsXXie12q1tre3h8Nhu902TfPs7Gx3d9f3/S+yvBzDMNSRNp1ODQNMJnoYho2a53le5bjUXNdDCPn4+KhM27ZPT083Nzf/lAAAHB4ebm1tdbvdlYIFQeD7fhiGs9nM83yZtnRnWRbGOE1TxhiEUJor5GixcFz3/f0dAGM2mxFChBCdTuf4+Pjo6Oju7u729tZxnPPz85OTE9u211xVkiRxHFeqbm5u9vf3d3Z2rq+vr66udF0/ODjY29vTNG2NZsZYmqbid/gic85d19Unk/5goGnaYDBMSlV5nsvxbrVaQoj5fO44Tr1nvtKWnWhZFkJITlV1KAgCVVWFEBjjJElWItfPYZzI7ml0IuecELKmPetrKE1T6btxjhAyHo8hhD+nSkb+Z1vWdB4EP8lZliVJUl1+vWArC/B/M0wIYT93GK+h2kFrked548snvi0YIQuONbIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"policy\"\n        title=\"policy\"\n        src=\"/static/52744e3d74287d9dc7db4b7d55e6ab75/0e2fe/policy.png\"\n        srcset=\"/static/52744e3d74287d9dc7db4b7d55e6ab75/c26ae/policy.png 158w,\n/static/52744e3d74287d9dc7db4b7d55e6ab75/0e2fe/policy.png 285w\"\n        sizes=\"(max-width: 285px) 100vw, 285px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">PolicyNet</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> inplanes<span class=\"token punctuation\">,</span> outplanes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>PolicyNet<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>outplanes <span class=\"token operator\">=</span> outplanes\n        self<span class=\"token punctuation\">.</span>conv <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>inplanes<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> kernel_size<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>bn <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>logsoftmax <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>LogSoftmax<span class=\"token punctuation\">(</span>dim<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>fc <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span>outplanes <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> outplanes<span class=\"token punctuation\">)</span>\n\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        x <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>relu<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>bn<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>conv<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        x <span class=\"token operator\">=</span> x<span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>outplanes <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        x <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>fc<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n        probas <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>logsoftmax<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>exp<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> probas</code></pre></div>\n<h3>Value head</h3>\n<p>The value network model is a bit more sophisticated. It also has the couple convolution, batch normalization, ReLU and then a fully connected layer. Another fully connected layer is added on top of that. Finally, a hyperbolic tangent is applied to create the scalar output in range <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">[</mo><mo>−</mo><mn>1</mn><mo separator=\"true\">;</mo><mn>1</mn><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">[-1;1]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord\">−</span><span class=\"mord\">1</span><span class=\"mpunct\">;</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">]</span></span></span></span></span> that represents how likely the player is to win given the current game state.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 286px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a2d7aa8dd313de4e97071f5d661685c7/357e3/value.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 174.0506329113924%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAjCAIAAAAblL1PAAAACXBIWXMAAA4mAAAN/wHwU+XzAAADk0lEQVRIx41WzUrkShSeN/IJfAjfoBHu7Nyp4MoBmbt3IaKIIC7UJxAEQXsjTLvQacTu0PmpJJ3OXyVV+e1KVSWXTpx0OmZm7rdKivPVOXXqO+fUF8553gDnPCMkz/PiF+rPfBWc8y+c84bdwnA4/Pn09AQAGAwGP34MXl9fn5+fB8/PcZLUNkVRtMkV4jhWFMW0zPF4LIqi67qSJMmKzBhrmnWTm/B933Edx3Ewxh6EhmEAVfV8VBQFY+y35EV4ee55XhAEEMLp1NA0LYoiCGGapiueOec+8nEJ14Xz+by1F6W0tdggM2aZlmmamqYqCkg+crNMD6WUEBLH8Z8S5nle855qzOdz0zQBUGv7JRljrGmaYRiyosiKYjtO8/Ct66x2X5IzmmGMwzDUdR0hFMdJyzMvxdTcpSNs3/ebYXPOKaUZIbQE+4VuMkKoJjPGhsPh7u7uP1+/qqra7/cFQdjc3Nzb21sEm2Uf5DiKRFGSFWU2mwFVlWWFkKwoijRNTdM0DIMQghAihOi6blnWikgYo2G0gOs4YRgGYVgVjG3bj4+Pt7e3AABJkiCEd3d39/f3aZp2hA0hbIYtCMLh4eH+/v77+/vLy4uu6/vfvv37/XsQBCvkiuP7fuWz3i5NU4RQrdMwDH+b7WbCPvKPEADAmM2M2cyyLMdxSJa1tY0xjuPYtm2EUBAEjPFm9Ta/2yLhnBslptOpqmm6PqWUVuuMMV6BsUptNeUvIsnzjyZVy6NDnnUwEMI6YXmeE0Iwxr7vVyXJGKsO1e0ZY9xS2M7OTq/XAwA8PDyMx+Ner7e9vb2isCgMBUGYiKJlWYqiiKJICKn48xKc8zRNGWNJklRdYek5z/NK+tDzsiwjZfflnAMArq6ujo+Px+PxcDiczWZnZ2cXFxdhKcElOcsyzrnrupTS5hXc3NwcHR1JkjQajUzTPD09PT8/j6JoSWaMTSaiLCuSJL29vYmiVFWvU2Kh9iCI45gQAiFMkqSj6RdFYdt2fRkY44ODg/X19Y2NjZOTk8vLy36/v7a2trW15XleR+sNgqCppCRJqpaalZLMsgwhVMW8cmbXdVVVnU6nQFVN02ypEiE0mUy6x03lxLKs0WgEoReGUbMTFUUhCML19XX92yGSPM+b9fxn/K+SrDUvyyuzrk2mlMqy8nnWLCQYRRjjqtS6yZzzspLZZzIhpOpbbXJz3n9+AdTvgLoe65fBf4YsxTveaTxXAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"value\"\n        title=\"value\"\n        src=\"/static/a2d7aa8dd313de4e97071f5d661685c7/357e3/value.png\"\n        srcset=\"/static/a2d7aa8dd313de4e97071f5d661685c7/c26ae/value.png 158w,\n/static/a2d7aa8dd313de4e97071f5d661685c7/357e3/value.png 286w\"\n        sizes=\"(max-width: 286px) 100vw, 286px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ValueNet</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> inplanes<span class=\"token punctuation\">,</span> outplanes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>ValueNet<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>outplanes <span class=\"token operator\">=</span> outplanes\n        self<span class=\"token punctuation\">.</span>conv <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>inplanes<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> kernel_size<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>bn <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>fc1 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span>outplanes <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>fc2 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        x <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>relu<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>bn<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>conv<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        x <span class=\"token operator\">=</span> x<span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>outplanes <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        x <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>relu<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>fc1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        winning <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>tanh<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>fc2<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> winning</code></pre></div>\n<br />\n<center>. . .</center>\n<h2>Monte Carlo Tree Search</h2>\n<p>Another major component of AlphaGo Zero is the asynchronous Monte Carlo Tree Search <em>(MCTS)</em>. This tree search algorithm is useful because it enables the network to think ahead and choose the best moves thanks to the simulations that it has made, without exploring every node at every step. Since Go is a perfect information game with a perfect simulator, it is possible to simulate a rollout of the environment and plan the response of the opponent far ahead, just like humans do. Let’s see how it is actually done.</p>\n<h3>Node</h3>\n<p>Each node in the tree represents a board state and stores different statistics : the number of times the node has been visited <em>(n)</em>, the total action value <em>(w)</em>, the prior probability of reaching that node <em>(p)</em>, the mean action value (<em>q</em>, which is <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>q</mi><mo>=</mo><mi>w</mi><mi mathvariant=\"normal\">/</mi><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">q = w / n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord\">/</span><span class=\"mord mathnormal\">n</span></span></span></span></span>) as well as the move made from the parent to reach that node, a pointer to the parent node and finally all the legal moves from this node that have a non-zero probability as children.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Node</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> parent<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> proba<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> move<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>p <span class=\"token operator\">=</span> proba\n        self<span class=\"token punctuation\">.</span>n <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        self<span class=\"token punctuation\">.</span>w <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        self<span class=\"token punctuation\">.</span>q <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        self<span class=\"token punctuation\">.</span>children <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n        self<span class=\"token punctuation\">.</span>parent <span class=\"token operator\">=</span> parent\n        self<span class=\"token punctuation\">.</span>move <span class=\"token operator\">=</span> move</code></pre></div>\n<br />\n<h3>Rollout</h3>\n<h4>PUCT selection algorithm</h4>\n<p>The first action in the tree search is choosing the action that maximize a variant of the Polynomial Upper Confience Trees <em>(PUCT)</em> formula. It allows the network to either explore unseen path early on, or further search the best possible moves later on thanks to the exploration constant _<span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>c</mi><mrow><mi>p</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">c_{puct}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\">u</span><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span></span>_.\nThe selection formula is defined as follows.</p>\n<p><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>U</mi><mo stretchy=\"false\">(</mo><mi>s</mi><mo separator=\"true\">,</mo><mi>a</mi><mo stretchy=\"false\">)</mo><mo>=</mo><msub><mi>c</mi><mrow><mi>p</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>∗</mo><mi>P</mi><mo stretchy=\"false\">(</mo><mi>s</mi><mo separator=\"true\">,</mo><mi>a</mi><mo stretchy=\"false\">)</mo><mo>∗</mo><mfrac><msqrt><mrow><msub><mo>∑</mo><mi>b</mi></msub><mrow><mi>N</mi><mo stretchy=\"false\">(</mo><mi>s</mi><mo separator=\"true\">,</mo><mi>b</mi><mo stretchy=\"false\">)</mo></mrow></mrow></msqrt><mrow><mn>1</mn><mo>+</mo><mi>N</mi><mo stretchy=\"false\">(</mo><mi>s</mi><mo separator=\"true\">,</mo><mi>a</mi><mo stretchy=\"false\">)</mo></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">U(s, a) = c_{puct} * P(s, a) * \\frac{\\sqrt{\\sum_b{N(s, b)}}}{1 + N(s, a)}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">s</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7514em;vertical-align:-0.2861em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\">u</span><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">s</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.8496em;vertical-align:-0.52em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.3296em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mbin mtight\">+</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">N</span><span class=\"mopen mtight\">(</span><span class=\"mord mathnormal mtight\">s</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mclose mtight\">)</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.6288em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord sqrt mtight\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.0012em;\"><span class=\"svg-align\" style=\"top:-3.4286em;\"><span class=\"pstrut\" style=\"height:3.4286em;\"></span><span class=\"mord mtight\" style=\"padding-left:1.19em;\"><span class=\"mop mtight\"><span class=\"mop op-symbol small-op mtight\" style=\"position:relative;top:0em;\">∑</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1746em;\"><span style=\"top:-2.1786em;margin-left:0em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">b</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3214em;\"><span></span></span></span></span></span></span><span class=\"mspace mtight\" style=\"margin-right:0.1952em;\"></span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">N</span><span class=\"mopen mtight\">(</span><span class=\"mord mathnormal mtight\">s</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mclose mtight\">)</span></span></span></span><span style=\"top:-2.9732em;\"><span class=\"pstrut\" style=\"height:3.4286em;\"></span><span class=\"hide-tail mtight\" style=\"min-width:0.853em;height:1.5429em;\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"400em\" height=\"1.5429em\" viewBox=\"0 0 400000 1080\" preserveAspectRatio=\"xMinYMin slice\"><path d=\"M95,702\nc-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14\nc0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54\nc44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10\ns173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429\nc69,-144,104.5,-217.7,106.5,-221\nl0 -0\nc5.3,-9.3,12,-14,20,-14\nH400000v40H845.2724\ns-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7\nc-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z\nM834 80h400000v40h-400000z\"></path></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.4554em;\"><span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.52em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<p>with <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi><mo stretchy=\"false\">(</mo><mi>s</mi><mo separator=\"true\">,</mo><mi>a</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P(s, a)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">s</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mclose\">)</span></span></span></span></span> the probability of being in that state and <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi><mo stretchy=\"false\">(</mo><mi>s</mi><mo separator=\"true\">,</mo><mi>a</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">N(s, a)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">s</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mclose\">)</span></span></span></span></span> the number of time that this specific state has been visited during the simulations.</p>\n<p>Here is how it is defined in code. This version is slightly less readable because it is optimized using numba.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">select</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">,</span> c_puct<span class=\"token operator\">=</span>C_PUCT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token string\">\" Optimized version of the selection based of the PUCT formula \"</span>\n\n    total_count <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        total_count <span class=\"token operator\">+=</span> nodes<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n\n    action_scores <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        action_scores<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> c_puct <span class=\"token operator\">*</span> nodes<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> \\\n                <span class=\"token punctuation\">(</span>np<span class=\"token punctuation\">.</span>sqrt<span class=\"token punctuation\">(</span>total_count<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">+</span> nodes<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    equals <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>where<span class=\"token punctuation\">(</span>action_scores <span class=\"token operator\">==</span> np<span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>action_scores<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">if</span> equals<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>choice<span class=\"token punctuation\">(</span>equals<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> equals<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span></code></pre></div>\n<h4>Ending</h4>\n<p>The selection continues until a leaf node is reached. A leaf node is a node that has not been expanded yet, which means that it must have no children.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">is_leaf</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\" Check whether a node is a leaf or not \"\"\"</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span></code></pre></div>\n<br/>\n<p>Once a leaf node is encountered, a random rotation or reflection of the state it contains is evaluated (because the rules of Go are invariant under rotation or reflection, more on that in the <em>training</em> section) using the value and policy networks to get the value of the current state and the probabilities of all the next moves. All forbidden moves have their probability changed to 0, and the probability vector is then renormalized to sum to 1.\nAfter that, the node is expanded with every legal moves (moves that have a non-zero probability in the <em>probas</em> array) given the state in the node, with the following function.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">expand</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> probas<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    self<span class=\"token punctuation\">.</span>children <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>Node<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>self<span class=\"token punctuation\">,</span> move<span class=\"token operator\">=</span>idx<span class=\"token punctuation\">,</span> proba<span class=\"token operator\">=</span>probas<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> \\\n                <span class=\"token keyword\">for</span> idx <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>probas<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> probas<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span></code></pre></div>\n<h4>Backup</h4>\n<p>Once the expansion is done, the statistics of the node and its parents are updated using the following function and loop, as well as the value that has been predicted by the value network.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">update</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\" Update the node statistics after a rollout \"\"\"</span>\n\n    self<span class=\"token punctuation\">.</span>w <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>w <span class=\"token operator\">+</span> v\n    self<span class=\"token punctuation\">.</span>q <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>w <span class=\"token operator\">/</span> self<span class=\"token punctuation\">.</span>n <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>n <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token keyword\">else</span> <span class=\"token number\">0</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">while</span> current_node<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">:</span>\n    current_node<span class=\"token punctuation\">.</span>update<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span>\n    current_node <span class=\"token operator\">=</span> current_node<span class=\"token punctuation\">.</span>parent</code></pre></div>\n<h3>Move selection</h3>\n<p>Now that the simulations have been made, each potential next move contains statistics that describe the quality of the move. The move selection follows two scenarios.\nThe first one is where AlphaGo plays competitively and the selected move is the most simulated one. This scenario is applied during the evaluation and when playing in general other than during training.\nThe second scenario is where a move is selected stochastically, by transforming the array of visited count into a probability distribution using the following scheme.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">total <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span><span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span>action_scores<span class=\"token punctuation\">)</span>\nprobas <span class=\"token operator\">=</span> action_scores <span class=\"token operator\">/</span> total\nmove <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>choice<span class=\"token punctuation\">(</span>action_scores<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> p<span class=\"token operator\">=</span>probas<span class=\"token punctuation\">)</span></code></pre></div>\n<br/>\n<p>This selection method allows AlphaGo to explore more potential options earlier on during training. After a certain amount of move (which is the <em>temperature</em> constant), the move selection becomes competitive.</p>\n<h2>Final pipeline</h2>\n<p>Now that every individual building block has been explained, let’s assemble them to see how AlphaGo has actually been trained.</p>\n<p>At the start of the program, at least two “core” processes are launched. The first one is the self-play and the second one is the training. Ideally, both processes would communicate via <em>RAM</em>. However, it is not trivial to pass information between different processes, which in this case is sending the generated games in the self-play process to the training process in order to update the dataset with the best quality games to make the agent learn from better games faster. To do that, I decided to use a MongoDB database instead, to be able to have each process run independently with only one true source of information.</p>\n<h3>Self-play</h3>\n<p>The self-play component is the one in charge of generating data. It works by using the current best agent to play against itself. After a game finishes (either by the two players passing, one of the player resigning or the number of moves becoming larger that a constant threshold), every registered action of the game is updated with the winner of the game, going from the shape <em>(board_state, move, player_color)</em> to <em>(board_state, move, winner)</em>. Every time a batch is generated, the process verifies that the current agent used to generate games is still the best agent. The following function is a rough sketch of how to self-play actually works.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">self_play</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n        new_player<span class=\"token punctuation\">,</span> checkpoint <span class=\"token operator\">=</span> load_player<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> new_player<span class=\"token punctuation\">:</span>\n            player <span class=\"token operator\">=</span> new_player\n\n        <span class=\"token comment\">## Create the self-play match queue of processes</span>\n        results <span class=\"token operator\">=</span> create_matches<span class=\"token punctuation\">(</span>player<span class=\"token punctuation\">,</span> cores<span class=\"token operator\">=</span>PARALLEL_SELF_PLAY<span class=\"token punctuation\">,</span>\n                                         match_number<span class=\"token operator\">=</span>SELF_PLAY_MATCH<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>SELF_PLAY_MATCH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            result <span class=\"token operator\">=</span> results<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            db<span class=\"token punctuation\">.</span>insert<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"game\"</span><span class=\"token punctuation\">:</span> result<span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">:</span> game_id\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n            game_id <span class=\"token operator\">+=</span> <span class=\"token number\">1</span></code></pre></div>\n<h3>Training</h3>\n<p>The training is relatively straightforward as well. The current best agent is trained using the new generated games. Each state in the dataset is augmented by applying all the dihedral rotations of a square (rotations and symmetries) to it to increase the size of the dataset. Every few iterations, the training process checks the database to see if the self-play process has generated new games and if it is the case, the training process fetches them and updates the dataset accordingly. After some iterations, the trained agent is sent to evaluation asynchronously in another process, as described in the function below.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">train</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    criterion <span class=\"token operator\">=</span> AlphaLoss<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    dataset <span class=\"token operator\">=</span> SelfPlayDataset<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    player<span class=\"token punctuation\">,</span> checkpoint <span class=\"token operator\">=</span> load_player<span class=\"token punctuation\">(</span>current_time<span class=\"token punctuation\">,</span> loaded_version<span class=\"token punctuation\">)</span>\n    optimizer <span class=\"token operator\">=</span> create_optimizer<span class=\"token punctuation\">(</span>player<span class=\"token punctuation\">,</span> lr<span class=\"token punctuation\">,</span>\n                                    param<span class=\"token operator\">=</span>checkpoint<span class=\"token punctuation\">[</span><span class=\"token string\">'optimizer'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    best_player <span class=\"token operator\">=</span> deepcopy<span class=\"token punctuation\">(</span>player<span class=\"token punctuation\">)</span>\n    dataloader <span class=\"token operator\">=</span> DataLoader<span class=\"token punctuation\">(</span>dataset<span class=\"token punctuation\">,</span> collate_fn<span class=\"token operator\">=</span>collate_fn<span class=\"token punctuation\">,</span> \\\n                batch_size<span class=\"token operator\">=</span>BATCH_SIZE<span class=\"token punctuation\">,</span> shuffle<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">for</span> batch_idx<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">,</span> move<span class=\"token punctuation\">,</span> winner<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>dataloader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n            <span class=\"token comment\">## Evaluate a copy of the current network</span>\n            <span class=\"token keyword\">if</span> total_ite <span class=\"token operator\">%</span> TRAIN_STEPS <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n                pending_player <span class=\"token operator\">=</span> deepcopy<span class=\"token punctuation\">(</span>player<span class=\"token punctuation\">)</span>\n                result <span class=\"token operator\">=</span> evaluate<span class=\"token punctuation\">(</span>pending_player<span class=\"token punctuation\">,</span> best_player<span class=\"token punctuation\">)</span>\n\n                <span class=\"token keyword\">if</span> result<span class=\"token punctuation\">:</span>\n                    best_player <span class=\"token operator\">=</span> pending_player\n\n            example <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">'state'</span><span class=\"token punctuation\">:</span> state<span class=\"token punctuation\">,</span>\n                <span class=\"token string\">'winner'</span><span class=\"token punctuation\">:</span> winner<span class=\"token punctuation\">,</span>\n                <span class=\"token string\">'move'</span> <span class=\"token punctuation\">:</span> move\n            <span class=\"token punctuation\">}</span>\n            optimizer<span class=\"token punctuation\">.</span>zero_grad<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            winner<span class=\"token punctuation\">,</span> probas <span class=\"token operator\">=</span> pending_player<span class=\"token punctuation\">.</span>predict<span class=\"token punctuation\">(</span>example<span class=\"token punctuation\">[</span><span class=\"token string\">'state'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n            loss <span class=\"token operator\">=</span> criterion<span class=\"token punctuation\">(</span>winner<span class=\"token punctuation\">,</span> example<span class=\"token punctuation\">[</span><span class=\"token string\">'winner'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> \\\n                            probas<span class=\"token punctuation\">,</span> example<span class=\"token punctuation\">[</span><span class=\"token string\">'move'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            loss<span class=\"token punctuation\">.</span>backward<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            optimizer<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n            <span class=\"token comment\">## Fetch new games</span>\n            <span class=\"token keyword\">if</span> total_ite <span class=\"token operator\">%</span> REFRESH_TICK <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n                last_id <span class=\"token operator\">=</span> fetch_new_games<span class=\"token punctuation\">(</span>collection<span class=\"token punctuation\">,</span> dataset<span class=\"token punctuation\">,</span> last_id<span class=\"token punctuation\">)</span></code></pre></div>\n<br/>\n<p>The loss function which is used to train the agent is the sum of the mean-squared error between the actual winner of the game and the predicted value, and the cross-entropy loss between the move that has been made and the predicted probability distribution. It is defined as follows in code.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">AlphaLoss</span><span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>AlphaLoss<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> pred_winner<span class=\"token punctuation\">,</span> winner<span class=\"token punctuation\">,</span> pred_probas<span class=\"token punctuation\">,</span> probas<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        value_error <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>winner <span class=\"token operator\">-</span> pred_winner<span class=\"token punctuation\">)</span> <span class=\"token operator\">**</span> <span class=\"token number\">2</span>\n        policy_error <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span><span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span>probas <span class=\"token operator\">*</span>\n                                <span class=\"token punctuation\">(</span><span class=\"token number\">1e-6</span> <span class=\"token operator\">+</span> pred_probas<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>log<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        total_error <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>value_error<span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> policy_error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>mean<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> total_error</code></pre></div>\n<h3>Evaluation</h3>\n<p>The evaluation consists of the current best agent playing against the trained agent using the competitive parameter (no exploration). They play a certain amount of games against each other, and if the trained agent beats the current best agent more than a certain amount of the time (55% of the time in the paper), then the trained agent is saved and becomes the new best agent.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">evaluate</span><span class=\"token punctuation\">(</span>player<span class=\"token punctuation\">,</span> new_player<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    results <span class=\"token operator\">=</span> play<span class=\"token punctuation\">(</span>player<span class=\"token punctuation\">,</span> opponent<span class=\"token operator\">=</span>new_player<span class=\"token punctuation\">)</span>\n    black_wins <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    white_wins <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n\n    <span class=\"token keyword\">for</span> result <span class=\"token keyword\">in</span> results<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span>\n            white_wins <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n        <span class=\"token keyword\">elif</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n            black_wins <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n\n    <span class=\"token comment\">## Check if the trained player (black) is better than</span>\n    <span class=\"token comment\">## the current best player depending on the threshold</span>\n    <span class=\"token keyword\">if</span> black_wins <span class=\"token operator\">>=</span> EVAL_THRESH <span class=\"token operator\">*</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>results<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">True</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">False</span></code></pre></div>\n<h2>Results</h2>\n<p>After a week of training on my school’s server, the agent played approximately 20k self-played games on a 9x9 Go board, using 128 MCTS simulations, playing 10 games in parallel. It did approximately 463k parameters update, with the best agent being replaced 417 times. Here is a clip of the best agent playing against himself.</p>\n<p><div class=\"gatsby-resp-iframe-wrapper\" style=\"padding-bottom: 50%; position: relative; height: 0; overflow: hidden; margin-bottom: 1.0725rem\" > <div><iframe src=\"https://www.youtube.com/embed/rkxBqK7f8qA\" style=\" position: absolute; top: 0; left: 0; width: 100%; height: 100%; \"></iframe></div> </div></p>\n<p>As the video shows, the agent did not learn the “fundamentals” of the game, like life and death, or even atari. However, it seems to have learned that it is generally a good move to answer locally. It also looks like the agent knows that Go is about territory and not frontal combat, which is shown in the first few moves. The shapes are also really bad, and the agent still plays inside his own living groups and killing them by removing liberties.</p>\n<h2>Discussion</h2>\n<p>I wasn’t able to get any promising results. It raises the question of whether I made errors in the implementation, or perhaps I used wrong hyperparameters. AlphaGo Zero was trained using 4.9 million games but with a way higher number of simulations (1600), so the poor results might also come from a lack of computation.</p>\n<h2>Acknowledgements</h2>\n<p>I want to thank my school’s AI association for letting me use the server to try to train this implementation of AlphaGo Zero. I would also like to thank everyone that gives feedback on the article. Be sure to get in touch with me if you have any suggestions or remarks about it.</p>\n<h2>References</h2>\n<ul>\n<li><a href=\"https://github.com/dylandjian/superGo\">The code for this article</a></li>\n<li><a href=\"https://www.nature.com/articles/nature24270.epdf?author_access_token=VJXbVjaSHxFoctQQ4p2k4tRgN0jAjWel9jnR3ZoTv0PVW4gB86EEpGqTRDtpIz-2rmo8-KG06gqVobU5NSCFeHILHcVFUeMsbvwS-lxjqQGg98faovwjxeTUgZAUMnRQ\">Mastering the game of Go without human knowledge</a> - DeepMind</li>\n<li><a href=\"https://applied-data.science/static/main/res/alpha_go_zero_cheat_sheet.png\">Very nice infographic on AlphaGo Zero</a> - David Foster</li>\n<li><a href=\"https://github.com/pasky/pachi\">Pachi Go game engine</a> - Petr Baudis</li>\n</ul>","frontmatter":{"title":"AlphaGo Zero demystified","date":"August 01, 2018","description":null}},"previous":{"fields":{"slug":"/blog/world-models/"},"frontmatter":{"title":"World Models applied to Sonic"}},"next":null},"pageContext":{"id":"d9cbcd1d-8083-57cc-889e-66e7290ed373","previousPostId":"96c5a760-db31-510a-8690-4271579b00cf","nextPostId":null}},"staticQueryHashes":["2841359383"]}